name: Gatling Performance Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  performance-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Run Gatling Test
        run: mvn gatling:test

      - name: Archive Gatling Report
        uses: actions/upload-artifact@v3
        with:
          name: gatling-report
          path: target/gatling/*

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: target/gatling

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      - name: Send Report to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          # è·å–æœ€æ–°çš„æµ‹è¯•æŠ¥å‘Šç›®å½•
          REPORT_DIR=$(ls -td target/gatling/* | head -1)
          # æå–æµ‹è¯•ç»“æœæ•°æ®
          TOTAL_REQUESTS=$(grep -r "request count" "$REPORT_DIR/js/stats.json" | grep -o '[0-9]\+')
          SUCCESS_RATE=$(grep -r "successfulRequests.percent" "$REPORT_DIR/js/assertions.json" | grep -o '[0-9]\+\.[0-9]\+')
          MAX_RESPONSE_TIME=$(grep -r "responseTime.max" "$REPORT_DIR/js/assertions.json" | grep -o '[0-9]\+')
          
          # æ„å»ºé£ä¹¦æ¶ˆæ¯
          MESSAGE="{
            \"msg_type\": \"post\",
            \"content\": {
              \"post\": {
                \"zh_cn\": {
                  \"title\": \"Gatlingæ€§èƒ½æµ‹è¯•æŠ¥å‘Š\",
                  \"content\": [
                    [{
                      \"tag\": \"text\",
                      \"text\": \"âœ… æ€§èƒ½æµ‹è¯•å·²å®Œæˆ\n\n\"
                    }],
                    [{
                      \"tag\": \"text\",
                      \"text\": \"ğŸ“Š æµ‹è¯•ç»“æœ:\n\"
                    }],
                    [{
                      \"tag\": \"text\",
                      \"text\": \"â€¢ æ€»è¯·æ±‚æ•°: ${TOTAL_REQUESTS}\nâ€¢ æˆåŠŸç‡: ${SUCCESS_RATE}%\nâ€¢ æœ€å¤§å“åº”æ—¶é—´: ${MAX_RESPONSE_TIME}ms\n\"
                    }],
                    [{
                      \"tag\": \"text\",
                      \"text\": \"ğŸ“ˆ è¯¦ç»†æŠ¥å‘Š: \"
                    }, {
                      \"tag\": \"a\",
                      \"text\": \"æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š\",
                      \"href\": \"${{ steps.deployment.outputs.page_url }}\"
                    }]
                  ]
                }
              }
            }
          }"
          
          # å‘é€åˆ°é£ä¹¦
          curl -X POST -H "Content-Type: application/json" -d "$MESSAGE" "$FEISHU_WEBHOOK"